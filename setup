#!/bin/bash

clear
echo
echo
echo "----------------  Please Wait  ---------------------"
echo
sudo apt-get update > /dev/null 2>&1
echo "----------------------------------------------------"
echo
sudo apt-get install dvswitch-server -y > /dev/null 2>&1
echo "----------------------------------------------------"
echo
sudo apt-get install multitail -y > /dev/null 2>&1
echo "----------------------------------------------------"
echo
sudo apt install htop -y  > /dev/null 2>&1
echo "----------------------------------------------------"
echo

files="dvsmu man_log DMRIds_chk.sh bm_watchdog.sh config_main_user.sh"

for file in $files; do
sudo wget -O /usr/local/dvs/$file https://raw.githubusercontent.com/hl5btf/DVSMU/main/$file > /dev/null 2>&1
sudo chmod +x /usr/local/dvs/$file
echo "----------------------------------------------------"
done


files="analog_bridge00.service mmdvm_bridge00.service md380-emu00.service"

for file in $files; do
sudo wget -O /var/lib/dvswitch/dvs/$file https://raw.githubusercontent.com/hl5btf/DVSMU/main/$file > /dev/null 2>&1
sudo chmod +x /var/lib/dvswitch/dvs/$file
echo "----------------------------------------------------"
done


sudo wget -O /var/lib/dvswitch/dvs/var00.txt https://raw.githubusercontent.com/hl5btf/DVSMU/main/var00.txt > /dev/null 2>&1
echo
echo "----------------------------------------------------"


sudo mkdir /var/lib/dvswitch/dvs/adv/user00 > /dev/null 2>&1
sudo wget -O /var/lib/dvswitch/dvs/adv/user00/dvsm.macro https://raw.githubusercontent.com/hl5btf/DVSMU/main/dvsm.macro > /dev/null 2>&1
sudo wget -O /var/lib/dvswitch/dvs/adv/user00/dvsm.adv https://raw.githubusercontent.com/hl5btf/DVSMU/main/dvsm.adv > /dev/null 2>&1
echo
echo "----------------------------------------------------"
sudo wget -O /var/lib/dvswitch/dvs/adv/user00/dvsm.basic https://raw.githubusercontent.com/hl5btf/DVSMU/main/dvsm.basic > /dev/null 2>&1
sudo wget -O /var/lib/dvswitch/dvs/adv/user00/dvsm.sh https://raw.githubusercontent.com/hl5btf/DVSMU/main/dvsm.sh > /dev/null 2>&1
sudo chmod +x /var/lib/dvswitch/dvs/adv/user00/dvsm.sh
echo
echo "----------------------------------------------------"

sudo mkdir /var/lib/dvswitch/dvs/adv/user00EN > /dev/null 2>&1
sudo mkdir /var/lib/dvswitch/dvs/adv/user00KR > /dev/null 2>&1

files="adv_audio.txt adv_dmr.txt adv_hotspot.txt adv_main.txt adv_managetg.txt adv_resetfvrt.txt adv_rxgain.txt adv_tgref.txt adv_tools.txt adv_txgain.txt"

for file in $files; do
sudo wget -O /var/lib/dvswitch/dvs/adv/user00EN/$file https://raw.githubusercontent.com/hl5btf/DVSMU/main/EN/$file > /dev/null 2>&1
sudo wget -O /var/lib/dvswitch/dvs/adv/user00KR/$file https://raw.githubusercontent.com/hl5btf/DVSMU/main/KR/$file > /dev/null 2>&1
echo
echo "----------------------------------------------------"
done


file=/etc/crontab

cron_daily_time=$(sed -n -e '/cron.daily/p' $file | cut -f 2 -d' ')
cron_daily_time=$(echo $cron_daily_time | cut -f1 -d' ')
cron_daily_min=$(sed -n -e '/cron.daily/p' $file | cut -f 1 -d' ')
cron_daily_min_plus_3=$((cron_daily_min + 3))
cron_daily_min_plus_4=$((cron_daily_min + 4))

echo "#reboot=yes" | sudo tee -a $file > /dev/null 2>&1
echo "#time=3" | sudo tee -a $file > /dev/null 2>&1
echo "0 3 * * * root /usr/local/dvs/man_log" | sudo tee -a $file > /dev/null 2>&1
echo "$cron_daily_min_plus_3 $cron_daily_time * * * root /usr/local/dvs/DMRIds_chk.sh" | sudo tee -a $file > /dev/null 2>&1
echo "*/5 * * * * root /usr/local/dvs/bm_watchdog.sh" | sudo tee -a $file > /dev/null 2>&1

#--------------------------------------------------------
### PATH 추가 ( 아래 내용 싱행후에 콘솔에서 source /etc/profile 를 실행해야 적용됨)
file="/etc/profile"

# 추가할 디렉토리 목록
read -r -d '' new_dirs << 'EOF'
/opt/MMDVM_Bridge
/usr/local/dvs
EOF

# 1. 기존 PATH 라인들 모두 추출
existing_path_lines=$(grep -n '^export PATH=' "$file" | cut -d: -f1)

# 2. 기존 경로 모으기
existing_paths=""
for line_no in $existing_path_lines; do
    line=$(sed -n "${line_no}p" "$file")
    # $PATH:$dir1:$dir2 형식에서 실제 경로만 추출
    paths=$(echo "$line" | sed -E 's/^export PATH=\$PATH:?//; s/["]//g' | tr ':' '\n')
    for path in $paths; do
        existing_paths="$existing_paths"$'\n'"$path"
    done
done

# 3. 새로 추가할 디렉토리와 기존 경로들을 하나로 정리
all_paths="$existing_paths"
for dir in $new_dirs; do
    all_paths="$all_paths"$'\n'"$dir"
done

# 4. 중복 제거 + 다시 PATH 라인으로 조립
unique_paths=$(echo "$all_paths" | grep -v '^$' | sort -u | tr '\n' ':' | sed 's/:$//')
new_export_line="export PATH=\$PATH:$unique_paths"

# 5. 기존 PATH 라인 모두 삭제
if [ -n "$existing_path_lines" ]; then
    sudo sed -i '/^export PATH=/d' "$file"
fi

# 6. 새 export PATH 줄 추가
echo "$new_export_line" | sudo tee -a "$file" > /dev/null

# 콘솔에서 source /etc/profile 를 실행해야 적용됨

#--------------------------------------------------------
### add_aliases.sh routine
file=add_aliases.sh
sudo wget https://raw.githubusercontent.com/hl5btf/DVSwitch/main/$file
sudo chmod +x $file
sudo ./$file

sudo rm $file
#---------------------------------------------------------

echo
echo "----------------------------------------------------"

echo "------------------  FINISHED  ----------------------"
echo
echo "-------------- 재부팅후 정상 작동함 ----------------"
echo
echo "---------- 재부팅 하시겠습니까? (y/n) --------------"
read reply
if [ "$reply" = Y ] || [ "$reply" = y ] || [ "$reply" = "" ]; then
clear
sudo rm setup > /dev/null 2>&1
sudo reboot
fi
exit 0

#--------------------------------------------------------
